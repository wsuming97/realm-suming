# Web é¢æ¿ UI å¢å¼ºè®¡åˆ’

## ğŸ“‹ æ¦‚è¿°

æœ¬è®¡åˆ’åŒ…å«ä¸¤ä¸ªä¸»è¦åŠŸèƒ½å¢å¼ºï¼š
1. **ç«¯å£æµé‡ç‹—é›†æˆ** - åœ¨é¢æ¿ä¸­æ·»åŠ æµé‡ç‹—å…¥å£
2. **å¤š IP åˆ‡æ¢åŠŸèƒ½** - æ”¯æŒè§„åˆ™é…ç½®å¤šä¸ªç›®æ ‡ IP å¹¶å¿«é€Ÿåˆ‡æ¢

---

## ğŸ¯ åŠŸèƒ½ä¸€ï¼šç«¯å£æµé‡ç‹—é¢æ¿é›†æˆ

### å½“å‰çŠ¶æ€åˆ†æ

ä» panel.sh ä»£ç åˆ†æï¼Œå½“å‰é¢æ¿ç»“æ„å¦‚ä¸‹ï¼š

```
å¯¼èˆªæ  (navbar)
â”œâ”€â”€ å“ç‰Œæ ‡è¯†: "Realm è½¬å‘é¢æ¿"
â”œâ”€â”€ é¢æ¿è®¾ç½®æŒ‰é’®
â””â”€â”€ ç™»å‡ºæŒ‰é’®

ä¸»å†…å®¹åŒº
â”œâ”€â”€ è¾“å…¥åŒºåŸŸ (card-fixed)
â”‚   â”œâ”€â”€ å¤‡æ³¨åç§°è¾“å…¥
â”‚   â”œâ”€â”€ ç›‘å¬ç«¯å£è¾“å…¥
â”‚   â”œâ”€â”€ ç›®æ ‡åœ°å€è¾“å…¥
â”‚   â”œâ”€â”€ æ·»åŠ æŒ‰é’®
â”‚   â””â”€â”€ å·¥å…·ç»„: æ‰¹é‡, å…¨åˆ , å¯¼å‡º, å¯¼å…¥
â”‚
â””â”€â”€ è§„åˆ™åˆ—è¡¨ (card-scroll)
    â””â”€â”€ è§„åˆ™è¡¨æ ¼
```

### è®¾è®¡æ–¹æ¡ˆ

#### æ–¹æ¡ˆ Aï¼šå¯¼èˆªæ æ·»åŠ æµé‡ç‹—æŒ‰é’®ï¼ˆæ¨èï¼‰

åœ¨å¯¼èˆªæ æ·»åŠ ä¸€ä¸ª"æµé‡ç‹—"æŒ‰é’®ï¼Œç‚¹å‡»åæ‰“å¼€æµé‡ç‹—ç®¡ç†ç•Œé¢ã€‚

```mermaid
graph LR
    A[å¯¼èˆªæ ] --> B[å“ç‰Œæ ‡è¯†]
    A --> C[æµé‡ç‹—æŒ‰é’® - æ–°å¢]
    A --> D[é¢æ¿è®¾ç½®]
    A --> E[ç™»å‡º]
    C --> F[æµé‡ç‹—é¢æ¿/å¼¹çª—]
```

**UI ä¿®æ”¹ä½ç½®** (panel.sh ç¬¬ 1533 è¡Œé™„è¿‘):
```html
<!-- åœ¨ nav-actions ä¸­æ·»åŠ  -->
<button class="btn btn-gray" onclick="openTrafficDog()">
  <i class="fas fa-dog"></i> 
  <span class="nav-text">æµé‡ç‹—</span>
</button>
```

#### æ–¹æ¡ˆ Bï¼šè®¾ç½®å¼¹çª—æ·»åŠ  Tab

åœ¨é¢æ¿è®¾ç½®å¼¹çª—ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„ Tab é¡µã€‚

**å½“å‰ Tab**: ç®¡ç†è´¦æˆ· | ä¸ªæ€§èƒŒæ™¯ | é€šçŸ¥è®¾ç½® | è¿œç¨‹èŠ‚ç‚¹
**æ–°å¢ Tab**: ç®¡ç†è´¦æˆ· | ä¸ªæ€§èƒŒæ™¯ | é€šçŸ¥è®¾ç½® | è¿œç¨‹èŠ‚ç‚¹ | **æµé‡ç‹—**

### æµé‡ç‹—ç•Œé¢è®¾è®¡

```mermaid
graph TD
    subgraph æµé‡ç‹—é¢æ¿
        A[ç«¯å£åˆ—è¡¨] --> A1[ç«¯å£å·]
        A --> A2[ä¸Šè¡Œæµé‡]
        A --> A3[ä¸‹è¡Œæµé‡]
        A --> A4[æ€»æµé‡]
        A --> A5[é™é€ŸçŠ¶æ€]
        A --> A6[æ“ä½œæŒ‰é’®]
        
        B[æ·»åŠ ç›‘æ§ç«¯å£] --> B1[ç«¯å£è¾“å…¥]
        B --> B2[é™é€Ÿè®¾ç½®]
        B --> B3[é…é¢è®¾ç½®]
        
        C[å…¨å±€è®¾ç½®] --> C1[åˆ·æ–°é—´éš”]
        C --> C2[é€šçŸ¥é…ç½®]
    end
```

### åç«¯ API è®¾è®¡

éœ€è¦åœ¨ Rust ä»£ç ä¸­æ·»åŠ æ–°çš„ API ç«¯ç‚¹ï¼š

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/traffic-dog/ports` | GET | è·å–æ‰€æœ‰ç›‘æ§ç«¯å£ |
| `/api/traffic-dog/ports` | POST | æ·»åŠ ç›‘æ§ç«¯å£ |
| `/api/traffic-dog/ports/:port` | DELETE | åˆ é™¤ç›‘æ§ç«¯å£ |
| `/api/traffic-dog/stats` | GET | è·å–æµé‡ç»Ÿè®¡ |
| `/api/traffic-dog/limit/:port` | POST | è®¾ç½®ç«¯å£é™é€Ÿ |

### å®æ–½æ­¥éª¤

1. ä¿®æ”¹ panel.sh HTML éƒ¨åˆ†ï¼Œæ·»åŠ æµé‡ç‹—æŒ‰é’®
2. æ·»åŠ æµé‡ç‹—å¼¹çª— Modal HTML
3. æ·»åŠ æµé‡ç‹—ç›¸å…³ JavaScript å‡½æ•°
4. æ·»åŠ  Rust åç«¯ API ç«¯ç‚¹
5. é›†æˆ nftables æµé‡è¯»å–é€»è¾‘

---

## ğŸ¯ åŠŸèƒ½äºŒï¼šå¤š IP åˆ‡æ¢åŠŸèƒ½

### éœ€æ±‚åˆ†æ

ç”¨æˆ·å¸Œæœ›ä¸€ä¸ªè½¬å‘è§„åˆ™å¯ä»¥é…ç½®å¤šä¸ªç›®æ ‡ IPï¼Œå¹¶èƒ½åœ¨é¢æ¿ä¸Šå¿«é€Ÿåˆ‡æ¢ï¼Œè€Œä¸éœ€è¦æ¯æ¬¡æ‰‹åŠ¨ä¿®æ”¹ã€‚

**ä½¿ç”¨åœºæ™¯**ï¼š
- ä¸»å¤‡åˆ‡æ¢ï¼šå½“ä¸»æœåŠ¡å™¨æ•…éšœæ—¶å¿«é€Ÿåˆ‡æ¢åˆ°å¤‡ç”¨
- å¤šçº¿è·¯åˆ‡æ¢ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µåˆ‡æ¢ä¸åŒçº¿è·¯
- æµ‹è¯•ç¯å¢ƒåˆ‡æ¢ï¼šå¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒå¿«é€Ÿåˆ‡æ¢

### æ•°æ®ç»“æ„ä¿®æ”¹

å½“å‰ Rule ç»“æ„ï¼š
```rust
struct Rule {
    id: String,
    name: String,
    listen: String,
    remote: String,  // å•ä¸ªç›®æ ‡
    // ...å…¶ä»–å­—æ®µ
}
```

ä¿®æ”¹ä¸ºï¼š
```rust
struct Rule {
    id: String,
    name: String,
    listen: String,
    remote: String,           // å½“å‰æ´»è·ƒç›®æ ‡
    remote_list: Vec<RemoteTarget>,  // å¤šç›®æ ‡åˆ—è¡¨ (æ–°å¢)
    // ...å…¶ä»–å­—æ®µ
}

struct RemoteTarget {
    address: String,    // IP:ç«¯å£
    label: String,      // æ ‡ç­¾/å¤‡æ³¨
    is_active: bool,    // æ˜¯å¦å½“å‰æ´»è·ƒ
}
```

### UI è®¾è®¡

#### è§„åˆ™åˆ—è¡¨æ˜¾ç¤º

åœ¨è§„åˆ™è¡Œçš„"ç›®æ ‡"åˆ—æ·»åŠ ä¸‹æ‹‰é€‰æ‹©å™¨æˆ–åˆ‡æ¢æŒ‰é’®ï¼š

```
| çŠ¶æ€ | å¤‡æ³¨ | ç›‘å¬ | ç›®æ ‡                              | æµé‡ | æ“ä½œ |
|------|------|------|-----------------------------------|------|------|
| ğŸŸ¢   | èŠ‚ç‚¹A | :443 | [1.2.3.4:443 â–¼] (ä¸») (å¤‡1) (å¤‡2) | 10GB | ...  |
```

#### ç¼–è¾‘è§„åˆ™å¼¹çª—

ä¿®æ”¹ç¼–è¾‘å¼¹çª—ï¼Œæ·»åŠ å¤šç›®æ ‡ç®¡ç†ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¼–è¾‘è§„åˆ™                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¤‡æ³¨: [èŠ‚ç‚¹A                          ] â”‚
â”‚ ç›‘å¬: [0.0.0.0:443                    ] â”‚
â”‚                                         â”‚
â”‚ ç›®æ ‡åœ°å€åˆ—è¡¨:                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â— 1.2.3.4:443    [ä¸»çº¿è·¯]    [åˆ é™¤] â”‚ â”‚
â”‚ â”‚ â—‹ 5.6.7.8:443    [å¤‡ç”¨1]     [åˆ é™¤] â”‚ â”‚
â”‚ â”‚ â—‹ 9.10.11.12:443 [å¤‡ç”¨2]     [åˆ é™¤] â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ [+ æ·»åŠ ç›®æ ‡]                            â”‚
â”‚                                         â”‚
â”‚ åˆ°æœŸæ—¶é—´: [                           ] â”‚
â”‚ æµé‡é™åˆ¶: [                           ] â”‚
â”‚                                         â”‚
â”‚                    [å–æ¶ˆ]  [ä¿å­˜]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¿«é€Ÿåˆ‡æ¢è®¾è®¡

åœ¨è§„åˆ™åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»ç›®æ ‡åœ°å€å¯ä»¥å±•å¼€ä¸‹æ‹‰èœå•è¿›è¡Œå¿«é€Ÿåˆ‡æ¢ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant UI as å‰ç«¯
    participant API as åç«¯API
    participant Realm as Realmè¿›ç¨‹
    
    U->>UI: ç‚¹å‡»ç›®æ ‡åœ°å€ä¸‹æ‹‰
    UI->>UI: æ˜¾ç¤ºç›®æ ‡åˆ—è¡¨
    U->>UI: é€‰æ‹©æ–°ç›®æ ‡
    UI->>API: PUT /api/rules/:id/switch-target
    API->>API: æ›´æ–° remote å­—æ®µ
    API->>Realm: é‡æ–°ç”Ÿæˆ config.toml
    API->>Realm: é‡è½½é…ç½®
    Realm-->>API: æˆåŠŸ
    API-->>UI: è¿”å›æˆåŠŸ
    UI->>UI: åˆ·æ–°è§„åˆ™åˆ—è¡¨
```

### åç«¯ API è®¾è®¡

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/rules/:id/targets` | GET | è·å–è§„åˆ™çš„ç›®æ ‡åˆ—è¡¨ |
| `/api/rules/:id/targets` | POST | æ·»åŠ ç›®æ ‡åˆ°åˆ—è¡¨ |
| `/api/rules/:id/targets/:idx` | DELETE | åˆ é™¤æŒ‡å®šç›®æ ‡ |
| `/api/rules/:id/switch-target` | POST | åˆ‡æ¢æ´»è·ƒç›®æ ‡ |

### å®æ–½æ­¥éª¤

1. ä¿®æ”¹ Rule ç»“æ„ä½“ï¼Œæ·»åŠ  remote_list å­—æ®µ
2. ä¿®æ”¹ JSON æ•°æ®è¯»å†™é€»è¾‘
3. ä¿®æ”¹ config.toml ç”Ÿæˆé€»è¾‘
4. æ·»åŠ æ–°çš„ API ç«¯ç‚¹
5. ä¿®æ”¹å‰ç«¯ HTML/CSS
6. æ·»åŠ å‰ç«¯ JavaScript é€»è¾‘
7. æµ‹è¯•åˆ‡æ¢åŠŸèƒ½å’Œé…ç½®é‡è½½

---

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `panel.sh` | æ·»åŠ æµé‡ç‹— UIã€å¤š IP åˆ‡æ¢ UIã€æ–° API ç«¯ç‚¹ã€Rust æ•°æ®ç»“æ„ä¿®æ”¹ |
| `README.md` | æ·»åŠ æ–°åŠŸèƒ½æ–‡æ¡£è¯´æ˜ |

### panel.sh ä¿®æ”¹è¯¦æƒ…

#### 1. HTML éƒ¨åˆ†ä¿®æ”¹ (ç¬¬ 1519-1599 è¡Œ)

- å¯¼èˆªæ æ·»åŠ æµé‡ç‹—æŒ‰é’®
- æ·»åŠ æµé‡ç‹— Modal
- ä¿®æ”¹è§„åˆ™ç¼–è¾‘ Modalï¼Œæ·»åŠ å¤šç›®æ ‡ç®¡ç†
- ä¿®æ”¹è§„åˆ™åˆ—è¡¨æ˜¾ç¤ºï¼Œæ·»åŠ ç›®æ ‡åˆ‡æ¢ä¸‹æ‹‰

#### 2. JavaScript éƒ¨åˆ†ä¿®æ”¹ (ç¬¬ 1540-1599 è¡Œ)

- æ·»åŠ  `openTrafficDog()` å‡½æ•°
- æ·»åŠ  `loadTrafficStats()` å‡½æ•°
- ä¿®æ”¹ `openEdit()` å‡½æ•°ï¼Œæ”¯æŒå¤šç›®æ ‡
- æ·»åŠ  `addRemoteTarget()` å‡½æ•°
- æ·»åŠ  `switchTarget()` å‡½æ•°

#### 3. Rust åç«¯ä¿®æ”¹ (ç¬¬ 700-1100 è¡Œ)

- ä¿®æ”¹ `Rule` ç»“æ„ä½“
- æ·»åŠ  `RemoteTarget` ç»“æ„ä½“
- æ·»åŠ æµé‡ç‹—ç›¸å…³ API å¤„ç†å‡½æ•°
- æ·»åŠ ç›®æ ‡åˆ‡æ¢ API å¤„ç†å‡½æ•°

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æµé‡ç‹—é›†æˆ - nftables æŸ¥è¯¢

```rust
// è¯»å– nftables æµé‡ç»Ÿè®¡
fn get_nftables_stats(port: &str) -> (u64, u64) {
    let output = Command::new("nft")
        .args(&["list", "chain", "inet", "port_traffic_dog", &format!("port_{}", port)])
        .output()
        .expect("Failed to execute nft");
    
    // è§£æè¾“å‡ºè·å– bytes è®¡æ•°
    // ...
}
```

### å¤šç›®æ ‡åˆ‡æ¢ - é…ç½®é‡è½½

```rust
// åˆ‡æ¢ç›®æ ‡åé‡æ–°ç”Ÿæˆé…ç½®
async fn switch_target(
    State(state): State<Arc<AppState>>,
    Path((id, target_idx)): Path<(String, usize)>,
) -> Response {
    let mut data = state.data.lock().unwrap();
    
    if let Some(rule) = data.rules.iter_mut().find(|r| r.id == id) {
        if target_idx < rule.remote_list.len() {
            // æ›´æ–°æ´»è·ƒç›®æ ‡
            for (i, t) in rule.remote_list.iter_mut().enumerate() {
                t.is_active = i == target_idx;
            }
            rule.remote = rule.remote_list[target_idx].address.clone();
            
            // ä¿å­˜å¹¶é‡è½½é…ç½®
            save_json(&data);
            save_config_toml(&data);
            reload_realm();
        }
    }
    
    Json(json!({"status": "ok"})).into_response()
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šremote_list ä¸ºç©ºæ—¶ï¼Œä½¿ç”¨ remote å­—æ®µä½œä¸ºå”¯ä¸€ç›®æ ‡
2. **é…ç½®è¿ç§»**ï¼šå‡çº§æ—¶è‡ªåŠ¨å°†ç°æœ‰ remote è¿ç§»åˆ° remote_list
3. **å¹¶å‘æ§åˆ¶**ï¼šåˆ‡æ¢ç›®æ ‡æ—¶éœ€è¦é”å®šé˜²æ­¢å¹¶å‘ä¿®æ”¹
4. **é‡è½½ä¼˜åŒ–**ï¼šæ‰¹é‡åˆ‡æ¢æ—¶åˆå¹¶é‡è½½æ“ä½œ

---

## âœ… éªŒæ”¶æ ‡å‡†

### æµé‡ç‹—é›†æˆ

- [ ] é¢æ¿å¯¼èˆªæ æ˜¾ç¤ºæµé‡ç‹—æŒ‰é’®
- [ ] ç‚¹å‡»æŒ‰é’®å¯æ‰“å¼€æµé‡ç‹—ç®¡ç†ç•Œé¢
- [ ] å¯æŸ¥çœ‹å„ç«¯å£æµé‡ç»Ÿè®¡
- [ ] å¯æ·»åŠ /åˆ é™¤ç›‘æ§ç«¯å£
- [ ] å¯è®¾ç½®ç«¯å£é™é€Ÿ

### å¤š IP åˆ‡æ¢

- [ ] ç¼–è¾‘è§„åˆ™æ—¶å¯æ·»åŠ å¤šä¸ªç›®æ ‡åœ°å€
- [ ] æ¯ä¸ªç›®æ ‡å¯è®¾ç½®æ ‡ç­¾
- [ ] è§„åˆ™åˆ—è¡¨æ˜¾ç¤ºå½“å‰æ´»è·ƒç›®æ ‡
- [ ] å¯å¿«é€Ÿåˆ‡æ¢ç›®æ ‡ï¼ˆæ— éœ€è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼‰
- [ ] åˆ‡æ¢åè‡ªåŠ¨é‡è½½ Realm é…ç½®
- [ ] å‘åå…¼å®¹ç°æœ‰è§„åˆ™æ•°æ®

---

## ğŸ“… å®æ–½é¡ºåº

1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šå¤š IP åˆ‡æ¢åŠŸèƒ½
   - æ•°æ®ç»“æ„ä¿®æ”¹
   - åç«¯ API
   - å‰ç«¯ UI

2. **ç¬¬äºŒé˜¶æ®µ**ï¼šæµé‡ç‹—é¢æ¿é›†æˆ
   - UI å…¥å£
   - æµé‡ç»Ÿè®¡å±•ç¤º
   - ç«¯å£ç®¡ç†åŠŸèƒ½

---

## ğŸš€ æ‰§è¡ŒæŒ‡ä»¤

å‡†å¤‡å°±ç»ªåï¼Œåˆ‡æ¢åˆ° Code æ¨¡å¼æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š

```
1. ä¿®æ”¹ panel.sh ä¸­çš„ Rule ç»“æ„ä½“ï¼Œæ·»åŠ  remote_list å­—æ®µ
2. æ·»åŠ  RemoteTarget ç»“æ„ä½“
3. ä¿®æ”¹ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–é€»è¾‘
4. æ·»åŠ  switch_target API ç«¯ç‚¹
5. ä¿®æ”¹å‰ç«¯ç¼–è¾‘å¼¹çª— HTML
6. æ·»åŠ å‰ç«¯å¤šç›®æ ‡ç®¡ç† JavaScript
7. æ·»åŠ è§„åˆ™åˆ—è¡¨ç›®æ ‡åˆ‡æ¢ä¸‹æ‹‰
8. æ·»åŠ æµé‡ç‹—å¯¼èˆªæŒ‰é’®å’Œå¼¹çª—
9. æµ‹è¯•åŠŸèƒ½
10. æ›´æ–° README.md
```
