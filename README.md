> 功能定位：**Realm 转发（含 Rust Web 面板）：一键安装、规则启停、定时备份、FTP/SFTP 备份**。

---

## 目录

- [功能概览](#功能概览)
- [环境要求](#环境要求)
- [一键安装](#一键安装)
- [脚本主菜单说明](#脚本主菜单说明)
- [Realm 安装 / 卸载 / 重启](#realm-安装--卸载--重启)
- [规则管理](#规则管理)
  - [添加规则](#添加规则)
  - [查看规则](#查看规则)
  - [修改规则](#修改规则)
  - [启用/暂停规则](#启用暂停规则)
  - [删除规则](#删除规则)
- [规则导出 / 导入](#规则导出--导入)
- [定时自动备份（cron）](#定时自动备份cron)
- [FTP / SFTP 异地备份](#ftp--sftp-异地备份)
- [Web 面板（Rust）](#web-面板rust)
- [端口流量狗](#端口流量狗)
- [常用路径](#常用路径)
- [常见问题](#常见问题)
- [安全建议](#安全建议)

---

## 功能概览

脚本提供：

- Realm **一键安装 / 卸载 / 更新**
- TCP + UDP 转发规则：**添加 / 删除 / 修改 / 启停**
- IPv4 / IPv6 监听与转发支持
- 规则冲突检测：
  - 配置内端口冲突检测
  - 系统端口占用检测（ss/netstat）
- 规则导入 / 导出
- 定时自动备份（cron）
- FTP / SFTP 远程自动备份
- 可选：**Rust Web 面板**（浏览器可视化管理规则）

适用场景：

- VPS 端口转发
- 游戏加速 / UDP 转发
- IPv6 中转
- 一键备份与快速恢复

---

## 环境要求

- **必须使用 root 运行**
- Linux（Debian/Ubuntu/CentOS/Alpine 等）
- 依赖（脚本会尽量自动安装/提示）：
  - `curl`、`tar`、`systemctl`
  - 端口检测：优先 `ss`，否则 `netstat`
  - cron：`cron/crond/crontab`（用于定时备份）
- Web 面板额外依赖（脚本会自动处理）：
  - Rust/cargo（通过 rustup 安装）
  - `build-essential/pkg-config/libssl-dev` 或 `Development Tools/openssl-devel`

---

## 一键安装

### 1️⃣ 一键运行（推荐）

```bash
bash <(curl -fsSL https://raw.githubusercontent.com/wsuming97/realm-suming/master/install.sh)
```

> ⚠️ 必须使用 root 用户运行  
> 如你是普通用户，请先：`sudo -i`

---

## 脚本主菜单说明

启动后会看到类似菜单（内容可能随版本调整）：

```
===== Realm TCP+UDP 转发脚本 =====
状态：运行中 | 版本：x.x.x
----------------------------------
1.  安装 Realm
2.  卸载 Realm
3.  重启 Realm
--------------------
4.  添加转发规则
5.  删除单条规则
6.  删除全部规则
7.  查看当前规则
8.  修改某条规则
9.  启动/暂停某条规则
--------------------
10. 查看日志
11. 查看配置
12. 一键导出所有规则
13. 一键导入所有规则
14. 添加/删除定时备份任务
15. 自动备份到FTP/SFTP
16. Realm 面板管理
17. 端口流量狗管理
0.  退出
```

---

## Realm 安装 / 卸载 / 重启

### 安装 Realm（第一次必须）

菜单：

```
1. 安装 Realm
```

脚本会：

- 自动识别 CPU 架构（x86_64 / arm / arm64）
- 自动识别 libc（glibc / musl）
- 自动下载 **GitHub 最新版本 Realm**
- 自动创建并启动 systemd 服务（`realm.service`）

### 卸载 Realm

菜单：

```
2. 卸载 Realm
```

会执行：

- 停止 Realm 服务
- 删除二进制文件
- 删除 systemd 服务
- 删除配置文件
- 同时会卸载（如已安装）面板相关组件

### 重启 Realm

菜单：

```
3. 重启 Realm
```

---

## 规则管理

### 添加规则

菜单：

```
4. 添加转发规则
```

按提示完成以下步骤：

1) 选择监听协议

- `1. IPv4（默认）`
- `2. IPv6`

2) 输入规则名称（支持中文）

- 长度 1-50
- 支持：中文 / 字母 / 数字 / `_` / `-`

示例：

```
游戏UDP加速
```

3) 输入监听端口

脚本会自动检测：

- 是否与现有规则冲突（配置端口冲突）
- 是否被系统占用（ss/netstat 检测）

4) 输入远程目标（目标地址:端口）

- IPv4 / 域名：

```
1.2.3.4:443
example.com:443
```

- IPv6：

```
[2001:db8::1]:443
```

5) 自动生效

- 添加完成后脚本会自动重启 Realm，使规则即时生效

---

### 查看规则

菜单：

```
7. 查看当前规则
```

示例输出：

```
1. [启用] [游戏UDP] 0.0.0.0:10000 -> 1.2.3.4:10000 (tcp+udp)
2. [暂停] [测试规则] [::]:20000 -> [2001:db8::1]:20000 (tcp+udp)
```

---

### 修改规则

菜单：

```
8. 修改某条规则
```

支持修改：

- 规则名称
- 监听端口
- 远程目标

修改完成后自动重启 Realm。

---

### 启用/暂停规则

菜单：

```
9. 启动/暂停某条规则
```

实现方式：

- 自动将该 `[[endpoints]]` 段落整体 **注释 / 取消注释**
- 不删除规则，仅暂停转发

---

### 删除规则

- 删除单条规则：

```
5. 删除单条规则
```

- 删除全部规则：

```
6. 删除全部规则
```

删除后自动重启 Realm。

---

## 规则导出 / 导入

> ✅ 强烈推荐在变更前先导出规则，便于快速恢复。

### 📤 导出所有规则

菜单：

```
12. 一键导出所有规则
```

默认导出路径：

```
/etc/realm/realm-rules.backup.toml
```

### 📥 导入规则

菜单：

```
13. 一键导入所有规则
```

支持两种模式：

1. 覆盖导入（清空原规则）
2. 追加导入（保留原规则并追加）

---

## 定时自动备份（cron）

菜单入口：

```
14. 添加/删除定时备份任务
```

支持：

- 每天备份
- 每周备份（指定星期）

脚本会自动生成：

- cron 文件：`/etc/cron.d/realm-rules-export`
- 导出脚本：`/usr/local/bin/realm-export-rules.sh`
- 备份文件：`/etc/realm/realm-rules.YYYY-MM-DD_HHMMSS.toml`

---

## FTP / SFTP 异地备份

菜单：

```
15. 自动备份到FTP/SFTP
```

功能：

- 调用 hiapb FTP 备份脚本进行上传
- 支持 FTP / SFTP
- 可多服务器异地备份

默认备份文件通常为：

```
/etc/realm/realm-rules.backup.toml
```

---

## Web 面板（Rust）

脚本菜单：

```
16. Realm 面板管理
```

你可以选择安装：

- **快速安装部署**
- **自编译部署**（Rust 编译）

> 快速安装依赖 GitHub Releases 预编译包（`realm-panel-amd.tar.gz` / `realm-panel-arm.tar.gz`）。  
> 若未上传该包，快速安装会失败并提示改用自编译（主菜单会自动尝试自编译）。

### 预编译包发布（可选）

在构建机（与目标架构一致）执行：

```bash
bash build-panel-release.sh
```

生成文件：

- `dist/realm-panel-amd.tar.gz`
- `dist/realm-panel-arm.tar.gz`

将对应文件上传到 GitHub Releases（tag 建议为 `realm`），与 `quickpanel.sh` 的下载链接保持一致。

也可以使用 GitHub Actions 自动构建并上传（见：`.github/workflows/release-panel.yml`）。

### 面板默认信息

- 默认端口：`4794`
- 默认用户名：`admin`
- 默认密码：`123456`

安装完成会输出访问地址：

```
http://<你的服务器IP>:4794
```

### 面板能力

- 登录鉴权（cookie session）
- 可视化管理规则：添加 / 编辑 / 删除 / 启停
- 一键删除，批量添加，一键导出/导入
- 带宽限速（tc）
- 月度流量配额与自动重置
- 通知告警配置（Telegram / 企业微信）
- 远程节点管理（多级链路转发 / API 令牌）
- 计费模式（单向 / 双向）
- 端口冲突检测（同端口禁止重复）
- 可在面板设置里修改：
  - 管理账户（用户名 / 密码）
  - PC/手机端背景图 URL
  - 远程节点与 API 令牌
- 规则保存到：

```
/etc/realm/panel_data.json
```

并会自动生成/刷新 Realm 配置：

```
/etc/realm/config.toml
```

> 注意：面板会将**启用的规则**写入 realm 配置，禁用规则不会写入 endpoints。  
> 若启用规则为空，为避免 Realm 无 endpoints，面板会写入一个 keepalive 的本地占位规则（127.0.0.1:65534）。

---

### 面板示例
![PC登录][1]
![PC主页][2]
![移动端][3]
![移动端][4]

## 端口流量狗

端口流量狗是一个强大的端口流量监控和管理工具，来自 [realm-xwPF](https://github.com/zywe03/realm-xwPF) 项目。

### 核心功能

- 📊 **流量监控**: 基于 nftables 的精确流量统计（支持双向/单向模式）
- 🚀 **带宽限速**: 使用 tc 流量控制实现端口级别限速
- 📈 **流量配额**: 月度流量配额管理，支持自动重置
- 🔔 **通知告警**: 支持 Telegram 和企业微信通知

### 使用方法

在主菜单选择 **17. 端口流量狗管理** 进入管理界面。

首次使用会自动下载脚本并安装依赖。

### 快捷命令

安装后可直接使用 `dog` 命令启动。

### 子菜单说明

| 选项 | 功能 |
|------|------|
| 1 | 添加/删除端口监控 |
| 2 | 端口限制设置管理（带宽/配额） |
| 3 | 流量重置管理 |
| 4 | 一键导出/导入配置 |
| 5 | 安装依赖(更新)脚本 |
| 6 | 卸载脚本 |
| 7 | 通知管理 |
| 0 | 退出 |

### 端口监控管理子菜单

| 选项 | 功能 |
|------|------|
| 1 | 添加端口监控 |
| 2 | 删除端口监控 |
| 3 | 一键清理并重建监控规则 |

### 数据存储

- 配置文件: `/etc/port-traffic-dog/config.json`
- 日志文件: `/etc/port-traffic-dog/logs/traffic.log`

---

## 常用路径

| 项目 | 路径 |
|---|---|
| Realm 配置 | `/etc/realm/config.toml` |
| Realm 二进制 | `/usr/local/bin/realm` |
| Realm systemd 服务 | `/etc/systemd/system/realm.service` |
| 规则备份 | `/etc/realm/realm-rules*.toml` |
| cron 任务 | `/etc/cron.d/realm-rules-export` |
| 面板二进制 | `/usr/local/bin/realm-panel` |
| 面板 systemd 服务 | `/etc/systemd/system/realm-panel.service` |
| 面板数据文件 | `/etc/realm/panel_data.json` |

---

## 常见问题

### Q1：修改规则后需要重启吗？

不需要手动重启。无论是脚本修改还是面板操作，都会自动重启 Realm 使之生效。

### Q2：支持 UDP 吗？

支持。脚本默认规则类型为：

- `type = "tcp+udp"`

### Q3：IPv6 VPS 能用吗？

可以。脚本支持 IPv6 监听与转发。

### Q4：端口提示被占用怎么办？

- 如果是 **配置冲突**（已有规则同端口），必须换端口
- 如果是 **系统占用**（ss/netstat 检测到），脚本会提示是否仍要使用该端口（不建议）

### Q5：面板无法访问？

排查：

1. 确认服务运行：
   ```bash
   systemctl status realm-panel --no-pager
   ```
2. 确认端口监听：
   ```bash
   ss -lntp | grep 4794
   ```
3. 检查服务器安全组/防火墙放行 `4794/tcp`

---

## 安全建议

- **强烈建议**：安装面板后第一时间修改默认密码（面板设置 → 管理账户）
- 建议通过防火墙/安全组限制面板端口仅允许可信 IP 访问
- 如对外开放面板，建议配合反代 + HTTPS（Nginx/Caddy）并启用访问控制
- 对关键配置建议定期导出备份，并保存在异地（FTP/SFTP）



